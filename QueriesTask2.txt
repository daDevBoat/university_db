Mandatory part
----------------------------------------------

1. Calculate the total hours (with the multiplication factor) along with the break-ups for each activity, for the current years’ course instances. 

SELECT 
    f.course_code, f.instance_id, f.hp, f.study_period, f.study_year, f.num_students, f.lecture_hours, f.seminar_hours, f.lab_hours, f.tutorial_hours, f.other_hours, f.exam_hours, f.admin_hours,
    f.lecture_hours + f.seminar_hours + f.lab_hours + f.tutorial_hours + f.other_hours + f.exam_hours + f.admin_hours AS total_hours
FROM (
    SELECT 
        l.course_code, i.instance_id, l.hp, l.study_period, i.study_year, i.num_students,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Lecture' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS lecture_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Seminar' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS seminar_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Lab' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS lab_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Tutorial' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS tutorial_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Other' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS other_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Exam' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS exam_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Admin' THEN ROUND((pa.planned_hours * ta.factor)::numeric, 2) END, 0)) AS admin_hours
    FROM course_instance i
    JOIN course_layout l ON l.course_layout_id = i.course_layout_id
    JOIN planned_activity pa ON pa.instance_id = i.instance_id
    JOIN teaching_activity ta ON ta.teaching_activity_id = pa.teaching_activity_id
    WHERE i.study_year = EXTRACT(YEAR FROM CURRENT_DATE)::int
    GROUP BY l.course_code, i.instance_id, l.hp, l.study_period, i.study_year, i.num_students) AS f
ORDER BY f.study_period;


2. Calculate the total allocated hours with the multiplication factor along with the break-ups for each activity and for each teacher, 
for a current years’ course instance.

SELECT 
    f.course_code, f.instance_id, f.hp, f.teacher_name, f.job_title, f.lecture_hours, f.seminar_hours, f.lab_hours, f.tutorial_hours, f.other_hours, f.exam_hours, f.admin_hours,
    f.lecture_hours + f.seminar_hours + f.lab_hours + f.tutorial_hours + f.other_hours + f.exam_hours + f.admin_hours AS total_hours
FROM (
    SELECT 
        l.course_code, i.instance_id, l.hp, p.first_name || ' ' || p.last_name AS teacher_name, j.job_title,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Lecture' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS lecture_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Seminar' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS seminar_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Lab' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS lab_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Tutorial' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS tutorial_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Other' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS other_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Exam' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS exam_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Admin' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS admin_hours
    FROM course_instance i
    JOIN course_layout l ON l.course_layout_id = i.course_layout_id
    JOIN planned_activity pa ON pa.instance_id = i.instance_id
    JOIN employee_planned_activity epa ON epa.planned_activity_id = pa.planned_activity_id
    JOIN employee e ON e.employement_id = epa.employement_id
    JOIN person p ON p.person_id = e.person_id
    JOIN job_title j ON j.job_title_id = e.job_title_id
    JOIN teaching_activity ta ON ta.teaching_activity_id = pa.teaching_activity_id
    WHERE i.instance_id IN (
        SELECT instance_id
        FROM course_instance
        WHERE study_year = EXTRACT(YEAR FROM CURRENT_DATE)::int
        ORDER BY instance_id ASC LIMIT 1
    )
    GROUP BY l.course_code, i.instance_id, l.hp, teacher_name, j.job_title) AS f
ORDER BY f.teacher_name ASC;


3. Calculate the total allocated hours (with multiplication factors) for a teacher, only for the current years’ course instances.

SELECT 
    f.course_code, f.instance_id, f.hp, f.study_period, f.teacher_name, f.lecture_hours, f.seminar_hours, f.lab_hours, f.tutorial_hours, f.other_hours, f.exam_hours, f.admin_hours,
    f.lecture_hours + f.seminar_hours + f.lab_hours + f.tutorial_hours + f.other_hours + f.exam_hours + f.admin_hours AS total_hours
FROM (
    SELECT 
        l.course_code, i.instance_id, l.hp, l.study_period, p.first_name || ' ' || p.last_name AS teacher_name,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Lecture' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS lecture_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Seminar' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS seminar_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Lab' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS lab_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Tutorial' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS tutorial_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Other' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS other_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Exam' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS exam_hours,
        SUM(COALESCE(CASE WHEN ta.activity_name = 'Admin' THEN ROUND((epa.allocated_hours * ta.factor)::numeric, 2) END, 0)) AS admin_hours
    FROM course_instance i 
    JOIN course_layout l ON l.course_layout_id = i.course_layout_id
    JOIN planned_activity pa ON pa.instance_id = i.instance_id
    JOIN employee_planned_activity epa ON epa.planned_activity_id = pa.planned_activity_id
    JOIN teaching_activity ta ON ta.teaching_activity_id = pa.teaching_activity_id
    JOIN employee e ON e.employement_id = epa.employement_id
    JOIN person p ON p.person_id = e.person_id
    WHERE i.study_year = EXTRACT(YEAR FROM CURRENT_DATE)::int AND p.first_name || ' ' || p.last_name = 'Josefin Pettersson'
    GROUP BY l.course_code, i.instance_id, l.hp, l.study_period, teacher_name) AS f
ORDER BY f.study_period ASC;


4. List employee ids and names of all teachers who are allocated in more than a specific number of course instances during the current period.

SELECT e.employement_id, p.first_name || ' ' || p.last_name AS teacher_name, l.study_period, COUNT(DISTINCT i.instance_id) AS num_of_courses
FROM employee e
JOIN person p ON p.person_id = e.person_id
JOIN job_title j ON j.job_title_id = e.job_title_id
JOIN employee_planned_activity epa ON epa.employement_id = e.employement_id
JOIN planned_activity pa ON pa.planned_activity_id = epa.planned_activity_id
JOIN course_instance i ON i.instance_id = pa.instance_id
JOIN course_layout l ON l.course_layout_id = i.course_layout_id
WHERE j.job_title = 'Teacher' AND i.study_year = EXTRACT(YEAR FROM CURRENT_DATE)::int AND l.study_period::char = get_current_period()::char
GROUP BY e.employement_id, p.first_name || ' ' || p.last_name, l.study_period
HAVING COUNT(DISTINCT i.instance_id) > 0;





Higher grade queries (see views.sql for the views used)
-----------------------------------------------------------

1. 
SELECT * FROM planned_hours_per_course_instance;

2.
SELECT 
    mv.course_code, mv.instance_id, mv.hp, mv.teacher_name, mv.job_title, 
    mv.lecture_hours, mv.seminar_hours, mv.lab_hours, mv.tutorial_hours, mv.other_hours, mv.exam_hours, mv.admin_hours, mv.total_hours
FROM allocated_hours_per_teacher mv
WHERE mv.instance_id IN (
    SELECT instance_id
    FROM course_instance
    WHERE study_year = EXTRACT(YEAR FROM CURRENT_DATE)::int
    ORDER BY instance_id ASC LIMIT 1
);

3. 
SELECT 
    mv.course_code, mv.instance_id, mv.hp, mv.study_period, mv.teacher_name, 
    mv.lecture_hours, mv.seminar_hours, mv.lab_hours, mv.tutorial_hours, mv.other_hours, mv.exam_hours, mv.admin_hours, mv.total_hours
FROM allocated_hours_per_teacher mv
WHERE mv.teacher_name = 'Josefin Pettersson';

4.
SELECT * FROM planned_hours_vs_allocated_hours_per_instance;

5. 
SELECT mv.employement_id, mv.teacher_name, mv.study_period, COUNT(DISTINCT mv.instance_id) AS num_of_courses 
FROM teachers_allocated_more_than_N_courses mv
GROUP BY mv.employement_id, mv.teacher_name, mv.study_period
HAVING COUNT(DISTINCT mv.instance_id) > 0;

